# OpenSwitchBridge 整体框架协议文档

## 1. 目标

本文档定义 OpenSwitchBridge 的整体协议框架：  
**应用层（AI/用户应用）→ 多通道控制协议（Wi-Fi/蓝牙/串口/I2C）→ 统一按键接口 → Switch 设备模拟层 → USB 发送到 Switch 主机。**

---

## 2. 分层架构图

```mermaid
flowchart TD
    A[应用层\nAI 应用 / 用户自定义应用 / 自动化脚本] --> B[接入层\nWi-Fi / 蓝牙 / 串口 / I2C]
    B --> C[统一按键调用接口\nns_protocol_set_test_button(...) 等]
    C --> D[协议与状态层\n按键映射 / 摇杆映射 / IMU 模拟 / 报文构建]
    D --> E[设备模拟层\nNintendo Switch Pro Controller HID 模拟]
    E --> F[传输层\nUSB HID IN/OUT]
    F --> G[Switch 主机\n游戏输入解析与执行]
```

---

## 3. 各层职责

### 3.1 应用层（最顶层）

- AI 行为控制（动作识别、策略控制）
- 用户自定义应用（脚本、遥控 App、测试工具）
- 只表达“意图”：按键、摇杆、组合动作、宏命令

### 3.2 接入层（控制通道）

- Wi-Fi（TCP/UDP/HTTP/WebSocket）
- 蓝牙（BLE/SPP 等）
- 串口（UART）
- I2C（主从控制）

职责：把外部命令统一转换为内部控制请求。

### 3.3 统一按键接口层

- 对上屏蔽通道差异（Wi-Fi/蓝牙/串口/I2C）
- 对下屏蔽 HID 位域细节
- 提供统一调用方式（如按钮枚举、摇杆坐标、IMU 开关）

### 3.4 协议与状态层

- 维护手柄状态（buttons、sticks、imu、vibration 等）
- 构造 `0x30`/`0x3F` 等输入报告
- 处理主机下发子命令（如 Enable IMU）

### 3.5 设备模拟层

- 模拟 Nintendo Switch Pro Controller 设备身份
- 实现 HID 描述符与报告格式兼容

### 3.6 USB 传输层

- 通过 USB HID 上报输入数据给 Switch
- 接收 Switch 下发控制命令并回包

---

## 4. 端到端调用链（核心路径）

1. 应用层发出控制意图（例：按下 A 键）
2. 通过 Wi-Fi/蓝牙/串口/I2C 任一通道进入设备
3. 转换为统一按键接口调用
4. 协议层更新状态并封装 HID 报文
5. USB 层发送到 Switch
6. Switch 将其识别为 Pro Controller 输入

---

## 5. 设计原则

- **统一入口**：所有外部通道最终走同一按键接口
- **分层解耦**：应用层与 USB/HID 实现细节隔离
- **可扩展性**：后续新增通道仅适配“接入层”
- **可测试性**：协议层可独立做按键/摇杆/IMU 自动化测试

---

## 6. 后续扩展建议

- 增加“动作宏接口”（按键序列 + 时间轴）
- 增加“会话与权限控制”（多客户端并发）
- 增加“协议版本字段”（便于 OTA 后兼容）
- 将 Wi-Fi 与蓝牙通道统一为同一命令格式（JSON/二进制 TLV）
