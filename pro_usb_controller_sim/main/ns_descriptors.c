#include "ns_descriptors.h"

#include "class/hid/hid_device.h"
#include "ns_proto.h"

#define USB_HID_ITF_NUM                     0
#define USB_HID_EP_IN                       0x81
#define USB_HID_EP_OUT                      0x01
#define USB_HID_EP_SIZE                     64
#define USB_HID_EP_INTERVAL                 1

/* Nintendo Switch Pro Controller HID report descriptor */
static const uint8_t s_ns_report_map[] = {
    0x05, 0x01, 0x09, 0x04, 0xA1, 0x01, 0x15, 0x00, 0x85, 0x30,
    0x05, 0x01, 0x05, 0x09, 0x19, 0x01, 0x29, 0x0A, 0x15, 0x00,
    0x25, 0x01, 0x75, 0x01, 0x95, 0x0A, 0x55, 0x00, 0x65, 0x00,
    0x81, 0x02, 0x05, 0x09, 0x19, 0x0B, 0x29, 0x0E, 0x15, 0x00,
    0x25, 0x01, 0x75, 0x01, 0x95, 0x04, 0x81, 0x02, 0x75, 0x01,
    0x95, 0x02, 0x81, 0x03, 0x0B, 0x01, 0x00, 0x01, 0x00, 0xA1,
    0x00, 0x0B, 0x30, 0x00, 0x01, 0x00, 0x0B, 0x31, 0x00, 0x01,
    0x00, 0x0B, 0x32, 0x00, 0x01, 0x00, 0x0B, 0x35, 0x00, 0x01,
    0x00, 0x15, 0x00, 0x27, 0xFF, 0xFF, 0x00, 0x00, 0x75, 0x10,
    0x95, 0x04, 0x81, 0x02, 0xC0, 0x0B, 0x39, 0x00, 0x01, 0x00,
    0x15, 0x00, 0x25, 0x07, 0x35, 0x00, 0x46, 0x3B, 0x01, 0x65,
    0x14, 0x75, 0x04, 0x95, 0x01, 0x81, 0x02, 0x05, 0x09, 0x19,
    0x0F, 0x29, 0x12, 0x15, 0x00, 0x25, 0x01, 0x75, 0x01, 0x95,
    0x04, 0x81, 0x02, 0x75, 0x08, 0x95, 0x34, 0x81, 0x03, 0x06,
    0x00, 0xFF, 0x85, 0x21, 0x09, 0x01, 0x75, 0x08, 0x95, 0x3F,
    0x81, 0x03, 0x85, 0x81, 0x09, 0x02, 0x75, 0x08, 0x95, 0x3F,
    0x81, 0x03, 0x85, 0x01, 0x09, 0x03, 0x75, 0x08, 0x95, 0x3F,
    0x91, 0x83, 0x85, 0x10, 0x09, 0x04, 0x75, 0x08, 0x95, 0x3F,
    0x91, 0x83, 0x85, 0x80, 0x09, 0x05, 0x75, 0x08, 0x95, 0x3F,
    0x91, 0x83, 0x85, 0x82, 0x09, 0x06, 0x75, 0x08, 0x95, 0x3F,
    0x91, 0x83, 0xC0
};

static const tusb_desc_device_t s_ns_device_desc = {
    .bLength            = sizeof(tusb_desc_device_t),
    .bDescriptorType    = TUSB_DESC_DEVICE,
    .bcdUSB             = 0x0200,
    .bDeviceClass       = TUSB_CLASS_UNSPECIFIED,
    .bDeviceSubClass    = 0x00,
    .bDeviceProtocol    = 0x00,
    .bMaxPacketSize0    = CFG_TUD_ENDPOINT0_SIZE,
    .idVendor           = NS_VENDOR_ID,
    .idProduct          = NS_PRODUCT_ID,
    .bcdDevice          = NS_BCD_DEVICE,
    .iManufacturer      = 0x01,
    .iProduct           = 0x02,
    .iSerialNumber      = 0x03,
    .bNumConfigurations = 0x01
};

#define TUSB_DESC_TOTAL_LEN (TUD_CONFIG_DESC_LEN + CFG_TUD_HID * TUD_HID_INOUT_DESC_LEN)

static const uint8_t s_ns_config_desc[] = {
    TUD_CONFIG_DESCRIPTOR(1, 1, 0, TUSB_DESC_TOTAL_LEN, 0x80, 100),
    TUD_HID_INOUT_DESCRIPTOR(USB_HID_ITF_NUM, 4, false, sizeof(s_ns_report_map),
                             USB_HID_EP_OUT, USB_HID_EP_IN, USB_HID_EP_SIZE, USB_HID_EP_INTERVAL),
};

static const char *s_ns_str_desc[] = {
    (char[]){0x09, 0x04},
    "Nintendo Co., Ltd.",
    "Pro Controller",
    "000000000001",
    "Nintendo Switch Pro Controller",
};

uint8_t const *ns_descriptors_report_map(void)
{
    return s_ns_report_map;
}

void ns_descriptors_fill_tusb_config(tinyusb_config_t *cfg)
{
    cfg->descriptor.device = &s_ns_device_desc;
    cfg->descriptor.full_speed_config = s_ns_config_desc;
#if (TUD_OPT_HIGH_SPEED)
    cfg->descriptor.high_speed_config = s_ns_config_desc;
#endif
    cfg->descriptor.string = s_ns_str_desc;
    cfg->descriptor.string_count = sizeof(s_ns_str_desc) / sizeof(s_ns_str_desc[0]);
}
